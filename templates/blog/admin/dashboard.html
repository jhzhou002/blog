{% extends 'blog/admin/base.html' %}
{% load static %}

{% block title %}{{ title }} - {{ site_name }}{% endblock %}

{% block admin_content %}
<div class="row">
    <!-- 统计卡片 -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            总文章数
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_posts }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-file-alt fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            已发布文章
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ published_posts }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            评论数
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_comments }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-comments fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            用户数
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_users }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-users fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 快速操作 -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">快速操作</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6 mb-3">
                        <a href="{% url 'blog:admin_post_add' %}" class="btn btn-primary btn-block">
                            <i class="fas fa-plus me-2"></i>新建文章
                        </a>
                    </div>
                    <div class="col-6 mb-3">
                        <a href="{% url 'blog:admin_posts' %}" class="btn btn-success btn-block">
                            <i class="fas fa-list me-2"></i>管理文章
                        </a>
                    </div>
                    <div class="col-6 mb-3">
                        <a href="{% url 'blog:admin_categories' %}" class="btn btn-info btn-block">
                            <i class="fas fa-folder me-2"></i>管理分类
                        </a>
                    </div>
                    <div class="col-6 mb-3">
                        <a href="{% url 'blog:admin_comments' %}" class="btn btn-warning btn-block">
                            <i class="fas fa-comments me-2"></i>管理评论
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 最新评论 -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">最新评论</h6>
            </div>
            <div class="card-body">
                {% for comment in recent_comments %}
                <div class="d-flex mb-3">
                    <div class="flex-shrink-0">
                        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                            <i class="fas fa-user text-muted"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="mb-1">{{ comment.user.username }}</h6>
                        <p class="mb-1 small">{{ comment.content|truncatechars:50 }}</p>
                        <small class="text-muted">
                            <a href="{{ comment.post.get_absolute_url }}" class="text-decoration-none">
                                {{ comment.post.title }}
                            </a> - {{ comment.created_at|date:"Y-m-d H:i" }}
                        </small>
                    </div>
                </div>
                {% empty %}
                <p class="text-muted">暂无评论</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- 图表区域 -->
<div class="row">
    <div class="col-xl-8 col-lg-7">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">文章发布统计</h6>
            </div>
            <div class="card-body">
                {% if published_posts > 0 %}
                    <div class="chart-area">
                        <canvas id="myAreaChart"></canvas>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">暂无文章数据</h5>
                        <p class="text-muted">发布一些文章后，这里将显示统计图表</p>
                        <a href="{% url 'blog:admin_post_add' %}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>立即发布文章
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-xl-4 col-lg-5">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">分类统计</h6>
            </div>
            <div class="card-body">
                {% if categories_with_posts %}
                    <div class="chart-pie pt-4 pb-2">
                        <canvas id="myPieChart"></canvas>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">暂无分类数据</h6>
                        <p class="text-muted">创建分类并发布文章后显示</p>
                        <a href="{% url 'blog:admin_categories' %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-folder me-1"></i>管理分类
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// 文章发布统计图表 - 只在有数据时初始化
{% if published_posts > 0 %}
var ctx = document.getElementById("myAreaChart");
if (ctx) {
  // 这里可以传入真实的统计数据
  var monthlyData = [
    {% for i in "123456789101112"|make_list %}
      {{ monthly_posts|default:"0" }},
    {% endfor %}
  ];
  
  var myLineChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"],
      datasets: [{
        label: "文章数量",
        lineTension: 0.3,
        backgroundColor: "rgba(59, 130, 246, 0.05)",
        borderColor: "rgba(59, 130, 246, 1)",
        pointRadius: 3,
        pointBackgroundColor: "rgba(59, 130, 246, 1)",
        pointBorderColor: "rgba(59, 130, 246, 1)",
        pointHoverRadius: 5,
        pointHoverBackgroundColor: "rgba(59, 130, 246, 1)",
        pointHoverBorderColor: "rgba(59, 130, 246, 1)",
        pointHitRadius: 10,
        pointBorderWidth: 2,
        data: monthlyData.length > 0 ? monthlyData : [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      }],
    },
    options: {
      maintainAspectRatio: false,
      responsive: true,
      layout: {
        padding: {
          left: 10,
          right: 25,
          top: 25,
          bottom: 0
        }
      },
      scales: {
        x: {
          grid: {
            display: false,
            drawBorder: false
          },
          ticks: {
            maxTicksLimit: 12,
            color: '#858796'
          }
        },
        y: {
          ticks: {
            maxTicksLimit: 5,
            padding: 10,
            color: '#858796',
            beginAtZero: true
          },
          grid: {
            color: "rgba(226, 232, 240, 0.5)",
            drawBorder: false,
            borderDash: [2]
          }
        }
      },
      plugins: {
        legend: {
          display: false
        }
      }
    }
  });
}
{% endif %}

// 分类统计饼图 - 只在有数据时初始化
{% if categories_with_posts %}
var ctx2 = document.getElementById("myPieChart");
if (ctx2) {
  var categoryData = {
    labels: [
      {% for category in categories_with_posts %}
        "{{ category.name }}",
      {% endfor %}
    ],
    data: [
      {% for category in categories_with_posts %}
        {{ category.post_count }},
      {% endfor %}
    ]
  };
  
  // 动态生成颜色
  var colors = ['#3b82f6', '#10b981', '#06b6d4', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
  var backgroundColors = categoryData.labels.map((_, index) => colors[index % colors.length]);
  
  var myPieChart = new Chart(ctx2, {
    type: 'doughnut',
    data: {
      labels: categoryData.labels,
      datasets: [{
        data: categoryData.data,
        backgroundColor: backgroundColors,
        hoverBackgroundColor: backgroundColors.map(color => color + 'CC'),
        borderWidth: 2,
        borderColor: '#ffffff'
      }],
    },
    options: {
      maintainAspectRatio: false,
      responsive: true,
      plugins: {
        tooltip: {
          backgroundColor: "rgb(255,255,255)",
          bodyColor: "#475569",
          titleColor: "#1e293b",
          borderColor: '#e2e8f0',
          borderWidth: 1,
          cornerRadius: 8,
          displayColors: true,
          callbacks: {
            label: function(context) {
              return context.label + ': ' + context.parsed + ' 篇文章';
            }
          }
        },
        legend: {
          display: true,
          position: 'bottom',
          labels: {
            usePointStyle: true,
            padding: 15,
            color: '#475569'
          }
        }
      },
      cutout: '60%',
    }
  });
}
{% endif %}
</script>
{% endblock %}