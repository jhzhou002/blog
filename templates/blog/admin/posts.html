{% extends 'blog/admin/base.html' %}
{% load static %}

{% block page_title %}{{ title }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/admin-common.css' %}">
<link rel="stylesheet" href="{% static 'css/admin-posts-list.css' %}">
{% endblock %}

{% block page_actions %}
<div class="page-actions-admin">
    <a href="{% url 'blog:admin_post_add' %}" class="btn-admin primary">
        <i class="fas fa-plus"></i>新建文章
    </a>
</div>
{% endblock %}

{% block admin_content %}
<!-- 页面头部 -->
<div class="page-header-admin">
    <div class="header-content">
        <div>
            <h1 class="page-title-admin">
                <i class="fas fa-newspaper"></i>文章管理
            </h1>
            <p class="page-subtitle-admin">管理和编辑你的博客文章</p>
        </div>
        <div class="text-center">
            <div class="stat-number text-white">{{ posts.paginator.count }}</div>
            <div class="stat-label text-white">篇文章</div>
        </div>
    </div>
</div>

<!-- 筛选器 -->
<div class="admin-card mb-4">
    <div class="admin-card-header">
        <span><i class="fas fa-filter"></i>筛选和搜索</span>
    </div>
    <div class="admin-card-body">
        <form method="get" id="filterForm">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group-admin">
                        <label class="form-label-admin">
                            <i class="fas fa-search"></i>搜索文章
                        </label>
                        <input type="text" name="search" class="form-input-admin" 
                               placeholder="输入标题或内容关键词..." 
                               value="{{ request.GET.search }}">
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="form-group-admin">
                        <label class="form-label-admin">
                            <i class="fas fa-folder"></i>分类
                        </label>
                        <select name="category" class="form-input-admin form-select-admin">
                            <option value="">所有分类</option>
                            {% for category in categories %}
                                <option value="{{ category.id }}" 
                                        {% if request.GET.category == category.id|stringformat:"s" %}selected{% endif %}>
                                    {{ category.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="form-group-admin">
                        <label class="form-label-admin">
                            <i class="fas fa-eye"></i>状态
                        </label>
                        <select name="status" class="form-input-admin form-select-admin">
                            <option value="">所有状态</option>
                            <option value="published" {% if request.GET.status == 'published' %}selected{% endif %}>已发布</option>
                            <option value="draft" {% if request.GET.status == 'draft' %}selected{% endif %}>草稿</option>
                            <option value="featured" {% if request.GET.status == 'featured' %}selected{% endif %}>推荐</option>
                            <option value="vip" {% if request.GET.status == 'vip' %}selected{% endif %}>VIP</option>
                        </select>
                    </div>
                </div>
                
                <div class="col-md-2">
                    <div class="form-group-admin">
                        <label class="form-label-admin">&nbsp;</label>
                        <button type="submit" class="btn-admin primary block">
                            <i class="fas fa-search"></i>筛选
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- 批量操作 -->
<div class="admin-card mb-4" id="bulkActions" style="display: none;">
    <div class="admin-card-header warning">
        <span>
            <i class="fas fa-tasks"></i>
            已选择 <span id="selectedCount">0</span> 篇文章
        </span>
    </div>
    <div class="admin-card-body">
        <div class="d-flex gap-md flex-wrap">
            <button type="button" class="btn-admin success" onclick="bulkPublish()">
                <i class="fas fa-globe"></i>批量发布
            </button>
            <button type="button" class="btn-admin secondary" onclick="bulkUnpublish()">
                <i class="fas fa-eye-slash"></i>取消发布
            </button>
            <button type="button" class="btn-admin danger" onclick="bulkDelete()">
                <i class="fas fa-trash"></i>批量删除
            </button>
            <button type="button" class="btn-admin outline" onclick="clearSelection()">
                <i class="fas fa-times"></i>取消选择
            </button>
        </div>
    </div>
</div>

<!-- 文章卡片网格 -->
{% if posts %}
<div class="row">
    {% for post in posts %}
    <div class="col-xl-4 col-lg-6 col-md-6 mb-4">
        <div class="admin-card animate-fade-in">
            <div class="admin-card-header">
                <div class="d-flex align-items-center gap-md">
                    <input type="checkbox" class="form-check-input-admin post-checkbox" value="{{ post.id }}" 
                           onchange="updateBulkActions()">
                    <div class="flex-fill">
                        <h6 class="mb-2 text-truncate">
                            <a href="{{ post.get_absolute_url }}" target="_blank" class="text-decoration-none">
                                {{ post.title|truncatechars:50 }}
                            </a>
                        </h6>
                        <div class="d-flex gap-sm flex-wrap">
                            <span class="badge-admin gray">
                                <i class="fas fa-user"></i>{{ post.author.username }}
                            </span>
                            <span class="badge-admin gray">
                                <i class="fas fa-calendar"></i>{{ post.created_at|date:"m-d" }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="admin-card-body">
                <!-- 状态徽章 -->
                <div class="d-flex gap-sm flex-wrap mb-3">
                    {% if post.category %}
                        <span class="badge-admin info">
                            <i class="fas fa-folder"></i>{{ post.category.name }}
                        </span>
                    {% endif %}
                    {% if post.is_published %}
                        <span class="badge-admin success">
                            <i class="fas fa-check"></i>已发布
                        </span>
                    {% else %}
                        <span class="badge-admin gray">
                            <i class="fas fa-edit"></i>草稿
                        </span>
                    {% endif %}
                    {% if post.is_featured %}
                        <span class="badge-admin warning">
                            <i class="fas fa-star"></i>推荐
                        </span>
                    {% endif %}
                    {% if post.is_vip_only %}
                        <span class="badge-admin warning">
                            <i class="fas fa-crown"></i>VIP
                        </span>
                    {% endif %}
                </div>
                
                <!-- 统计数据 -->
                <div class="row text-center mb-3">
                    <div class="col-4">
                        <div class="stat-number">{{ post.views }}</div>
                        <div class="stat-label">浏览</div>
                    </div>
                    <div class="col-4">
                        <div class="stat-number">{{ post.likes }}</div>
                        <div class="stat-label">点赞</div>
                    </div>
                    <div class="col-4">
                        <div class="stat-number">{{ post.comment_count }}</div>
                        <div class="stat-label">评论</div>
                    </div>
                </div>
            </div>
            
            <div class="admin-card-footer">
                <div class="d-flex gap-sm justify-content-center w-100">
                    <a href="{{ post.get_absolute_url }}" target="_blank" class="btn-admin info small">
                        <i class="fas fa-eye"></i>查看
                    </a>
                    <a href="{% url 'blog:admin_post_edit' post.pk %}" class="btn-admin success small">
                        <i class="fas fa-edit"></i>编辑
                    </a>
                    <a href="{% url 'blog:admin_post_delete' post.pk %}" 
                       class="btn-admin danger small" 
                       onclick="return confirm('确定要删除这篇文章吗？')">
                        <i class="fas fa-trash"></i>删除
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="admin-card text-center">
    <div class="admin-card-body" style="padding: 4rem 2rem;">
        <div style="font-size: 4rem; color: var(--gray-300); margin-bottom: 2rem;">
            <i class="fas fa-newspaper"></i>
        </div>
        <h3 style="color: var(--gray-700); margin-bottom: 1rem;">还没有文章</h3>
        <p style="color: var(--gray-500); margin-bottom: 2rem;">开始创建你的第一篇博客文章吧！</p>
        <a href="{% url 'blog:admin_post_add' %}" class="btn-admin primary large">
            <i class="fas fa-plus"></i>创建文章
        </a>
    </div>
</div>
{% endif %}

<!-- 分页 -->
{% if posts.has_other_pages %}
<div class="pagination-admin">
    {% if posts.has_previous %}
        <a href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
           class="page-link">
            <i class="fas fa-angle-double-left"></i>
        </a>
        <a href="?page={{ posts.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
           class="page-link">
            <i class="fas fa-angle-left"></i>
        </a>
    {% endif %}
    
    {% for num in posts.paginator.page_range %}
        {% if posts.number == num %}
            <span class="page-link active">{{ num }}</span>
        {% elif num > posts.number|add:'-3' and num < posts.number|add:'3' %}
            <a href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
               class="page-link">{{ num }}</a>
        {% endif %}
    {% endfor %}
    
    {% if posts.has_next %}
        <a href="?page={{ posts.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
           class="page-link">
            <i class="fas fa-angle-right"></i>
        </a>
        <a href="?page={{ posts.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
           class="page-link">
            <i class="fas fa-angle-double-right"></i>
        </a>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// 批量操作功能
let selectedPosts = new Set();

function updateBulkActions() {
    const checkboxes = document.querySelectorAll('.post-checkbox');
    selectedPosts.clear();
    
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
            selectedPosts.add(checkbox.value);
        }
    });
    
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');
    
    if (selectedPosts.size > 0) {
        bulkActions.style.display = 'block';
        bulkActions.classList.add('animate-fade-in');
        selectedCount.textContent = selectedPosts.size;
    } else {
        bulkActions.style.display = 'none';
        bulkActions.classList.remove('animate-fade-in');
    }
}

function clearSelection() {
    const checkboxes = document.querySelectorAll('.post-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = false);
    updateBulkActions();
}

function bulkPublish() {
    if (selectedPosts.size === 0) return;
    
    if (confirm(`确定要发布选中的 ${selectedPosts.size} 篇文章吗？`)) {
        // 这里可以添加AJAX请求来批量发布
        console.log('批量发布:', Array.from(selectedPosts));
        // 实际项目中需要实现后端接口
    }
}

function bulkUnpublish() {
    if (selectedPosts.size === 0) return;
    
    if (confirm(`确定要取消发布选中的 ${selectedPosts.size} 篇文章吗？`)) {
        // 这里可以添加AJAX请求来批量取消发布
        console.log('批量取消发布:', Array.from(selectedPosts));
        // 实际项目中需要实现后端接口
    }
}

function bulkDelete() {
    if (selectedPosts.size === 0) return;
    
    if (confirm(`确定要删除选中的 ${selectedPosts.size} 篇文章吗？此操作不可恢复！`)) {
        // 这里可以添加AJAX请求来批量删除
        console.log('批量删除:', Array.from(selectedPosts));
        // 实际项目中需要实现后端接口
    }
}

// 搜索功能
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.querySelector('input[name="search"]');
    const categorySelect = document.querySelector('select[name="category"]');
    const statusSelect = document.querySelector('select[name="status"]');
    
    // 自动提交搜索（防抖）
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            document.getElementById('filterForm').submit();
        }, 500);
    });
    
    // 分类和状态改变时自动提交
    categorySelect.addEventListener('change', function() {
        document.getElementById('filterForm').submit();
    });
    
    statusSelect.addEventListener('change', function() {
        document.getElementById('filterForm').submit();
    });
});

// 键盘快捷键
document.addEventListener('keydown', function(e) {
    // Ctrl+A 全选
    if (e.ctrlKey && e.key === 'a' && e.target.tagName !== 'INPUT') {
        e.preventDefault();
        const checkboxes = document.querySelectorAll('.post-checkbox');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = !allChecked;
        });
        updateBulkActions();
    }
    
    // Escape 取消选择
    if (e.key === 'Escape') {
        clearSelection();
    }
});
</script>
{% endblock %}