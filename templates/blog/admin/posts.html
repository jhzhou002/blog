{% extends 'blog/admin/base.html' %}
{% load static %}

{% block page_title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin-posts-list.css' %}">
{% endblock %}

{% block page_actions %}
<a href="{% url 'blog:admin_post_add' %}" class="btn btn-primary">
    <i class="fas fa-plus me-2"></i>新建文章
</a>
{% endblock %}

{% block admin_content %}
<!-- 页面头部 -->
<div class="posts-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1><i class="fas fa-newspaper me-2"></i>文章管理</h1>
            <p class="subtitle">管理和编辑你的博客文章</p>
        </div>
        <div class="text-end">
            <div style="font-size: 2rem; opacity: 0.9;">{{ posts.paginator.count }}</div>
            <div style="font-size: 0.9rem; opacity: 0.8;">篇文章</div>
        </div>
    </div>
</div>

<!-- 筛选器 -->
<div class="posts-filters">
    <form method="get" id="filterForm">
        <div class="filter-row">
            <div class="filter-group">
                <label class="filter-label">
                    <i class="fas fa-search me-1"></i>搜索文章
                </label>
                <input type="text" name="search" class="filter-input" 
                       placeholder="输入标题或内容关键词..." 
                       value="{{ request.GET.search }}">
            </div>
            
            <div class="filter-group">
                <label class="filter-label">
                    <i class="fas fa-folder me-1"></i>分类
                </label>
                <select name="category" class="filter-input">
                    <option value="">所有分类</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}" 
                                {% if request.GET.category == category.id|stringformat:"s" %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">
                    <i class="fas fa-eye me-1"></i>状态
                </label>
                <select name="status" class="filter-input">
                    <option value="">所有状态</option>
                    <option value="published" {% if request.GET.status == 'published' %}selected{% endif %}>已发布</option>
                    <option value="draft" {% if request.GET.status == 'draft' %}selected{% endif %}>草稿</option>
                    <option value="featured" {% if request.GET.status == 'featured' %}selected{% endif %}>推荐</option>
                    <option value="vip" {% if request.GET.status == 'vip' %}selected{% endif %}>VIP</option>
                </select>
            </div>
            
            <div class="filter-group">
                <button type="submit" class="btn btn-primary" style="padding: 10px 20px; border-radius: 8px;">
                    <i class="fas fa-filter me-1"></i>筛选
                </button>
            </div>
        </div>
    </form>
</div>

<!-- 批量操作 -->
<div class="bulk-actions" id="bulkActions">
    <div class="bulk-actions-content">
        <span class="selected-count">
            已选择 <span id="selectedCount">0</span> 篇文章
        </span>
        <button type="button" class="bulk-btn" onclick="bulkPublish()">
            <i class="fas fa-globe me-1"></i>批量发布
        </button>
        <button type="button" class="bulk-btn" onclick="bulkUnpublish()">
            <i class="fas fa-eye-slash me-1"></i>取消发布
        </button>
        <button type="button" class="bulk-btn danger" onclick="bulkDelete()">
            <i class="fas fa-trash me-1"></i>批量删除
        </button>
        <button type="button" class="bulk-btn" onclick="clearSelection()">
            <i class="fas fa-times me-1"></i>取消选择
        </button>
    </div>
</div>

<!-- 文章卡片网格 -->
{% if posts %}
<div class="posts-grid">
    {% for post in posts %}
    <div class="post-card">
        <div class="post-card-header">
            <div style="display: flex; align-items: flex-start; gap: 12px;">
                <input type="checkbox" class="post-checkbox" value="{{ post.id }}" 
                       style="margin-top: 4px;" onchange="updateBulkActions()">
                <div style="flex: 1;">
                    <h3 class="post-title">
                        <a href="{{ post.get_absolute_url }}" target="_blank">
                            {{ post.title|truncatechars:60 }}
                        </a>
                    </h3>
                    <div class="post-meta">
                        <span><i class="fas fa-user me-1"></i>{{ post.author.username }}</span>
                        <span><i class="fas fa-calendar me-1"></i>{{ post.created_at|date:"m-d" }}</span>
                        {% if post.category %}
                            <span class="post-badge badge-category">
                                <i class="fas fa-folder me-1"></i>{{ post.category.name }}
                            </span>
                        {% endif %}
                        {% if post.is_published %}
                            <span class="post-badge badge-published">
                                <i class="fas fa-check me-1"></i>已发布
                            </span>
                        {% else %}
                            <span class="post-badge badge-draft">
                                <i class="fas fa-edit me-1"></i>草稿
                            </span>
                        {% endif %}
                        {% if post.is_featured %}
                            <span class="post-badge badge-featured">
                                <i class="fas fa-star me-1"></i>推荐
                            </span>
                        {% endif %}
                        {% if post.is_vip_only %}
                            <span class="post-badge badge-vip">
                                <i class="fas fa-crown me-1"></i>VIP
                            </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="post-card-body">
            <div class="post-stats">
                <div class="stat-item">
                    <span class="stat-number">{{ post.views }}</span>
                    <span class="stat-label">浏览</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">{{ post.likes }}</span>
                    <span class="stat-label">点赞</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">{{ post.comment_count }}</span>
                    <span class="stat-label">评论</span>
                </div>
            </div>
            
            <div class="post-actions">
                <a href="{{ post.get_absolute_url }}" target="_blank" class="action-btn btn-view">
                    <i class="fas fa-eye"></i>查看
                </a>
                <a href="{% url 'blog:admin_post_edit' post.pk %}" class="action-btn btn-edit">
                    <i class="fas fa-edit"></i>编辑
                </a>
                <a href="{% url 'blog:admin_post_delete' post.pk %}" 
                   class="action-btn btn-delete" 
                   onclick="return confirm('确定要删除这篇文章吗？')">
                    <i class="fas fa-trash"></i>删除
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="empty-state">
    <div class="empty-icon">
        <i class="fas fa-newspaper"></i>
    </div>
    <h3 class="empty-title">还没有文章</h3>
    <p class="empty-text">开始创建你的第一篇博客文章吧！</p>
    <a href="{% url 'blog:admin_post_add' %}" class="btn btn-primary">
        <i class="fas fa-plus me-2"></i>创建文章
    </a>
</div>
{% endif %}

<!-- 分页 -->
{% if posts.has_other_pages %}
<div class="pagination-container">
    <div class="pagination">
        {% if posts.has_previous %}
            <a href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
               class="page-btn">
                <i class="fas fa-angle-double-left"></i>
            </a>
            <a href="?page={{ posts.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
               class="page-btn">
                <i class="fas fa-angle-left"></i>
            </a>
        {% endif %}
        
        {% for num in posts.paginator.page_range %}
            {% if posts.number == num %}
                <span class="page-btn active">{{ num }}</span>
            {% elif num > posts.number|add:'-3' and num < posts.number|add:'3' %}
                <a href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
                   class="page-btn">{{ num }}</a>
            {% endif %}
        {% endfor %}
        
        {% if posts.has_next %}
            <a href="?page={{ posts.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
               class="page-btn">
                <i class="fas fa-angle-right"></i>
            </a>
            <a href="?page={{ posts.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
               class="page-btn">
                <i class="fas fa-angle-double-right"></i>
            </a>
        {% endif %}
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// 批量操作功能
let selectedPosts = new Set();

function updateBulkActions() {
    const checkboxes = document.querySelectorAll('.post-checkbox');
    selectedPosts.clear();
    
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
            selectedPosts.add(checkbox.value);
        }
    });
    
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');
    
    if (selectedPosts.size > 0) {
        bulkActions.classList.add('show');
        selectedCount.textContent = selectedPosts.size;
    } else {
        bulkActions.classList.remove('show');
    }
}

function clearSelection() {
    const checkboxes = document.querySelectorAll('.post-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = false);
    updateBulkActions();
}

function bulkPublish() {
    if (selectedPosts.size === 0) return;
    
    if (confirm(`确定要发布选中的 ${selectedPosts.size} 篇文章吗？`)) {
        // 这里可以添加AJAX请求来批量发布
        console.log('批量发布:', Array.from(selectedPosts));
        // 实际项目中需要实现后端接口
    }
}

function bulkUnpublish() {
    if (selectedPosts.size === 0) return;
    
    if (confirm(`确定要取消发布选中的 ${selectedPosts.size} 篇文章吗？`)) {
        // 这里可以添加AJAX请求来批量取消发布
        console.log('批量取消发布:', Array.from(selectedPosts));
        // 实际项目中需要实现后端接口
    }
}

function bulkDelete() {
    if (selectedPosts.size === 0) return;
    
    if (confirm(`确定要删除选中的 ${selectedPosts.size} 篇文章吗？此操作不可恢复！`)) {
        // 这里可以添加AJAX请求来批量删除
        console.log('批量删除:', Array.from(selectedPosts));
        // 实际项目中需要实现后端接口
    }
}

// 搜索功能
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.querySelector('input[name="search"]');
    const categorySelect = document.querySelector('select[name="category"]');
    const statusSelect = document.querySelector('select[name="status"]');
    
    // 自动提交搜索（防抖）
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            document.getElementById('filterForm').submit();
        }, 500);
    });
    
    // 分类和状态改变时自动提交
    categorySelect.addEventListener('change', function() {
        document.getElementById('filterForm').submit();
    });
    
    statusSelect.addEventListener('change', function() {
        document.getElementById('filterForm').submit();
    });
});

// 键盘快捷键
document.addEventListener('keydown', function(e) {
    // Ctrl+A 全选
    if (e.ctrlKey && e.key === 'a' && e.target.tagName !== 'INPUT') {
        e.preventDefault();
        const checkboxes = document.querySelectorAll('.post-checkbox');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = !allChecked;
        });
        updateBulkActions();
    }
    
    // Escape 取消选择
    if (e.key === 'Escape') {
        clearSelection();
    }
});
</script>
{% endblock %}