{% extends 'blog/admin/base.html' %}
{% load static %}

{% block page_title %}{{ title }}{% endblock %}

{% block page_actions %}
<a href="{% url 'blog:admin_posts' %}" class="btn btn-secondary">
    <i class="fas fa-arrow-left me-2"></i>返回列表
</a>
{% endblock %}

{% block admin_content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">{{ title }}</h6>
            </div>
            <div class="card-body">
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
                
                <form method="post" enctype="multipart/form-data" id="postForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="title" class="form-label">标题 *</label>
                        <input type="text" class="form-control" id="title" name="title" 
                               value="{% if post %}{{ post.title }}{% endif %}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="summary" class="form-label">摘要</label>
                        <textarea class="form-control" id="summary" name="summary" rows="3">{% if post %}{{ post.summary }}{% endif %}</textarea>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label for="content" class="form-label mb-0">内容 *</label>
                            <div class="btn-group btn-group-sm" role="group">
                                <input type="radio" class="btn-check" name="editor-mode" id="rich-editor" checked>
                                <label class="btn btn-outline-primary" for="rich-editor">富文本编辑器</label>
                                
                                <input type="radio" class="btn-check" name="editor-mode" id="markdown-editor">
                                <label class="btn btn-outline-primary" for="markdown-editor">Markdown编辑器</label>
                            </div>
                        </div>
                        <textarea class="form-control" id="content" name="content" rows="15" required>{% if post %}{{ post.content }}{% endif %}</textarea>
                        
                        <!-- Markdown 预览区域 -->
                        <div id="markdown-preview" class="mt-3" style="display: none;">
                            <div class="border p-3 bg-light">
                                <h6>预览:</h6>
                                <div id="preview-content"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="cover_image" class="form-label">封面图片</label>
                        <input type="file" class="form-control" id="cover_image" name="cover_image" accept="image/*">
                        {% if post.cover_image %}
                            <div class="mt-2">
                                <img src="{{ post.cover_image }}" alt="当前封面" style="max-width: 200px; height: auto;">
                                <p class="small text-muted mt-1">当前封面图片</p>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>保存文章
                            </button>
                            <button type="button" class="btn btn-secondary ms-2" onclick="history.back()">取消</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- 发布选项 -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">发布选项</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="is_published" name="is_published"
                               form="postForm" {% if not post or post.is_published %}checked{% endif %}>
                        <label class="form-check-label" for="is_published">
                            发布文章
                        </label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="is_featured" name="is_featured"
                               form="postForm" {% if post.is_featured %}checked{% endif %}>
                        <label class="form-check-label" for="is_featured">
                            推荐文章
                        </label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="is_vip_only" name="is_vip_only"
                               form="postForm" {% if post.is_vip_only %}checked{% endif %}>
                        <label class="form-check-label" for="is_vip_only">
                            <i class="fas fa-crown text-warning me-1"></i>设为VIP文章
                        </label>
                        <div class="form-text">
                            <small class="text-muted">仅VIP用户可以阅读此文章</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 分类 -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">分类</h6>
            </div>
            <div class="card-body">
                <select class="form-control" name="category" form="postForm">
                    <option value="">请选择分类</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}" 
                                {% if post.category_id == category.id %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <!-- 标签 -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">标签</h6>
            </div>
            <div class="card-body">
                {% for tag in tags %}
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="tags" value="{{ tag.id }}"
                               id="tag_{{ tag.id }}" form="postForm"
                               {% if post and tag in post.tags.all %}checked{% endif %}>
                        <label class="form-check-label" for="tag_{{ tag.id }}">
                            {{ tag.name }}
                        </label>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- TinyMCE CDN -->
<script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
<!-- Marked.js for Markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

<script>
let currentEditorMode = 'rich'; // 'rich' or 'markdown'
let tinyMCEInstance = null;

// 初始化TinyMCE富文本编辑器
function initTinyMCE() {
    if (tinyMCEInstance) {
        return; // 已经初始化
    }
    
    tinymce.init({
        selector: '#content',
        height: 500,
        menubar: 'file edit view insert format tools table help',
        plugins: [
            'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
            'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
            'insertdatetime', 'media', 'table', 'help', 'wordcount'
        ],
        toolbar: 'undo redo | blocks | ' +
            'bold italic forecolor | alignleft aligncenter ' +
            'alignright alignjustify | bullist numlist outdent indent | ' +
            'removeformat | help | fullscreen | code',
        content_style: 'body { font-family:Arial,sans-serif; font-size:14px }',
        language: 'zh_CN',
        branding: false,
        resize: true,
        // 添加图片上传功能配置
        images_upload_url: false, // 禁用默认图片上传
        // 自定义图片上传处理
        images_upload_handler: function (blobInfo, success, failure) {
            console.log('图片上传暂未配置');
            failure('图片上传功能暂未配置');
        },
        // 自定义样式
        content_css: [
            '{% static "css/style.css" %}'
        ],
        // 支持HTML5
        extended_valid_elements: 'script[src|async|defer|type|charset]',
        // 代码高亮相关
        codesample_languages: [
            {text: 'HTML/XML', value: 'markup'},
            {text: 'JavaScript', value: 'javascript'},
            {text: 'CSS', value: 'css'},
            {text: 'Python', value: 'python'},
            {text: 'Java', value: 'java'},
            {text: 'C++', value: 'cpp'},
            {text: 'C#', value: 'csharp'},
            {text: 'SQL', value: 'sql'},
            {text: 'JSON', value: 'json'}
        ],
        // 表格样式
        table_default_attributes: {
            'class': 'table table-bordered'
        },
        // 段落格式
        block_formats: '段落=p; 标题1=h1; 标题2=h2; 标题3=h3; 标题4=h4; 标题5=h5; 标题6=h6; 预格式=pre',
        // 初始化完成回调
        init_instance_callback: function (editor) {
            console.log('TinyMCE编辑器初始化完成');
            tinyMCEInstance = editor;
        }
    });
}

// 销毁TinyMCE编辑器
function destroyTinyMCE() {
    if (tinyMCEInstance) {
        tinymce.remove('#content');
        tinyMCEInstance = null;
    }
}

// 初始化Markdown编辑器
function initMarkdownEditor() {
    const textarea = document.getElementById('content');
    const previewDiv = document.getElementById('markdown-preview');
    const previewContent = document.getElementById('preview-content');
    
    // 显示预览区域
    previewDiv.style.display = 'block';
    
    // 添加Markdown工具栏
    if (!document.getElementById('markdown-toolbar')) {
        const toolbar = document.createElement('div');
        toolbar.id = 'markdown-toolbar';
        toolbar.className = 'btn-toolbar mb-2';
        toolbar.innerHTML = `
            <div class="btn-group btn-group-sm me-2">
                <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('**', '**', '粗体文本')" title="粗体">
                    <i class="fas fa-bold"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('*', '*', '斜体文本')" title="斜体">
                    <i class="fas fa-italic"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('~~', '~~', '删除线文本')" title="删除线">
                    <i class="fas fa-strikethrough"></i>
                </button>
            </div>
            <div class="btn-group btn-group-sm me-2">
                <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('# ', '', '标题')" title="标题1">H1</button>
                <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('## ', '', '标题')" title="标题2">H2</button>
                <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('### ', '', '标题')" title="标题3">H3</button>
            </div>
            <div class="btn-group btn-group-sm me-2">
                <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('[', '](链接地址)', '链接文本')" title="链接">
                    <i class="fas fa-link"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('![](', ')', '图片描述')" title="图片">
                    <i class="fas fa-image"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('\`\`\`\\n', '\\n\`\`\`', '代码内容')" title="代码块">
                    <i class="fas fa-code"></i>
                </button>
            </div>
            <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('- ', '', '列表项')" title="无序列表">
                    <i class="fas fa-list-ul"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('1. ', '', '列表项')" title="有序列表">
                    <i class="fas fa-list-ol"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('> ', '', '引用内容')" title="引用">
                    <i class="fas fa-quote-right"></i>
                </button>
            </div>
        `;
        textarea.parentNode.insertBefore(toolbar, textarea);
    }
    
    // 监听输入变化，实时更新预览
    textarea.addEventListener('input', function() {
        updateMarkdownPreview();
    });
    
    // 初始预览
    updateMarkdownPreview();
}

// 清理Markdown编辑器
function cleanupMarkdownEditor() {
    const previewDiv = document.getElementById('markdown-preview');
    const toolbar = document.getElementById('markdown-toolbar');
    
    if (previewDiv) {
        previewDiv.style.display = 'none';
    }
    
    if (toolbar) {
        toolbar.remove();
    }
}

// 插入Markdown语法
function insertMarkdown(prefix, suffix, placeholder) {
    const textarea = document.getElementById('content');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    const insertText = selectedText || placeholder;
    
    const newText = prefix + insertText + suffix;
    textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
    
    // 设置光标位置
    if (selectedText) {
        textarea.setSelectionRange(start, start + newText.length);
    } else {
        textarea.setSelectionRange(start + prefix.length, start + prefix.length + placeholder.length);
    }
    
    textarea.focus();
    updateMarkdownPreview();
}

// 更新Markdown预览
function updateMarkdownPreview() {
    const textarea = document.getElementById('content');
    const previewContent = document.getElementById('preview-content');
    
    if (textarea && previewContent) {
        const markdownText = textarea.value;
        const htmlContent = marked.parse(markdownText);
        previewContent.innerHTML = htmlContent;
    }
}

// 编辑器模式切换
document.addEventListener('DOMContentLoaded', function() {
    const richEditorRadio = document.getElementById('rich-editor');
    const markdownEditorRadio = document.getElementById('markdown-editor');
    
    // 默认初始化富文本编辑器
    initTinyMCE();
    
    richEditorRadio.addEventListener('change', function() {
        if (this.checked) {
            currentEditorMode = 'rich';
            cleanupMarkdownEditor();
            setTimeout(() => {
                initTinyMCE();
            }, 100);
        }
    });
    
    markdownEditorRadio.addEventListener('change', function() {
        if (this.checked) {
            currentEditorMode = 'markdown';
            destroyTinyMCE();
            setTimeout(() => {
                initMarkdownEditor();
            }, 100);
        }
    });
});

// 表单提交前验证
document.querySelector('form').addEventListener('submit', function(e) {
    const title = document.getElementById('title').value.trim();
    let content = '';
    
    if (currentEditorMode === 'rich' && tinyMCEInstance) {
        // 获取TinyMCE编辑器内容
        content = tinyMCEInstance.getContent().trim();
        // 确保TinyMCE内容同步到textarea
        tinymce.triggerSave();
    } else {
        // 获取普通textarea内容
        content = document.getElementById('content').value.trim();
    }
    
    if (!title || !content) {
        e.preventDefault();
        alert('标题和内容不能为空');
        return false;
    }
});
</script>
{% endblock %}