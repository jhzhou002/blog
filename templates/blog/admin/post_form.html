{% extends 'blog/admin/base.html' %}
{% load static %}

{% block page_title %}{{ title }}{% endblock %}

{% block page_actions %}
<a href="{% url 'blog:admin_posts' %}" class="btn btn-secondary">
    <i class="fas fa-arrow-left me-2"></i>返回列表
</a>
{% endblock %}

{% block admin_content %}
<style>
/* 专用于文章编辑页面的样式 */
.article-edit-container {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 30px;
    max-width: 100%;
    margin: 0;
}

.main-content {
    min-width: 0; /* 防止内容溢出 */
}

.sidebar {
    min-width: 300px;
    max-width: 400px;
}

@media (max-width: 1200px) {
    .article-edit-container {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .sidebar {
        min-width: auto;
        max-width: none;
    }
}

.content-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    border: 1px solid #e5e7eb;
    overflow: hidden;
    margin-bottom: 20px;
}

.content-card-header {
    padding: 20px 24px;
    border-bottom: 1px solid #e5e7eb;
    font-weight: 600;
    font-size: 16px;
    color: #1f2937;
}

.content-card-body {
    padding: 24px;
}

.editor-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.info-header {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
}

.sidebar-header {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    color: white;
}

.editor-toggle {
    display: flex;
    gap: 8px;
}

.editor-toggle .btn {
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: rgba(255, 255, 255, 0.9);
    background: transparent;
    font-size: 14px;
}

.editor-toggle .btn.active {
    background: rgba(255, 255, 255, 0.2);
    color: white;
}

.form-section {
    margin-bottom: 20px;
}

.form-section:last-child {
    margin-bottom: 0;
}

.form-label {
    font-weight: 600;
    color: #374151;
    margin-bottom: 8px;
    display: block;
}

.form-control {
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 14px;
    transition: border-color 0.2s;
}

.form-control:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    outline: none;
}

.action-buttons {
    display: flex;
    gap: 12px;
    padding: 20px 24px;
    background: #f9fafb;
    border-top: 1px solid #e5e7eb;
    margin-top: 20px;
    border-radius: 0 0 12px 12px;
}

.btn-primary {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    transition: transform 0.2s;
}

.btn-primary:hover {
    transform: translateY(-1px);
}

.btn-secondary {
    background: #6b7280;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    color: white;
}

.sidebar .content-card {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
}

.form-check {
    margin-bottom: 12px;
}

.form-check-label {
    font-weight: 500;
    color: #374151;
    margin-left: 8px;
}

/* CKEditor样式 */
.ck.ck-editor {
    border: 2px solid #e5e7eb;
    border-radius: 8px;
}

.ck.ck-editor__editable {
    min-height: 400px;
}

#markdown-preview {
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    background: #f8fafc;
    padding: 16px;
    margin-top: 12px;
}
</style>

<div class="article-edit-container">
    <!-- 主内容区域 -->
    <div class="main-content">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert" style="margin-bottom: 20px;">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        <!-- 基本信息卡片 -->
        <div class="content-card">
            <div class="content-card-header info-header">
                文章基本信息
            </div>
            <div class="content-card-body">
                <form method="post" enctype="multipart/form-data" id="postForm">
                    {% csrf_token %}
                    
                    <div class="form-section">
                        <label for="title" class="form-label">文章标题 *</label>
                        <input type="text" class="form-control" id="title" name="title" 
                               value="{% if post %}{{ post.title }}{% endif %}" required 
                               placeholder="请输入文章标题">
                    </div>
                    
                    <div class="form-section">
                        <label for="summary" class="form-label">文章摘要</label>
                        <textarea class="form-control" id="summary" name="summary" rows="3" 
                                  placeholder="请输入文章摘要（可选）">{% if post %}{{ post.summary }}{% endif %}</textarea>
                    </div>
                    
                    <div class="form-section">
                        <label for="cover_image" class="form-label">封面图片</label>
                        <input type="file" class="form-control" id="cover_image" name="cover_image" accept="image/*">
                        {% if post.cover_image %}
                            <div style="margin-top: 12px;">
                                <img src="{{ post.cover_image }}" alt="当前封面" style="max-width: 200px; height: auto; border-radius: 8px;">
                                <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">当前封面图片</p>
                            </div>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>

        <!-- 内容编辑器卡片 -->
        <div class="content-card">
            <div class="content-card-header editor-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>文章内容 *</span>
                    <div class="editor-toggle">
                        <button type="button" class="btn btn-sm active" id="rich-mode-btn" onclick="switchEditorMode('rich')">
                            富文本编辑
                        </button>
                        <button type="button" class="btn btn-sm" id="markdown-mode-btn" onclick="switchEditorMode('markdown')">
                            Markdown
                        </button>
                    </div>
                </div>
            </div>
            <div class="content-card-body">
                <div id="editor-container">
                    <textarea class="form-control" id="content" name="content" rows="20" form="postForm" required 
                              placeholder="开始编写你的文章内容...">{% if post %}{{ post.content }}{% endif %}</textarea>
                </div>
                
                <!-- Markdown 预览区域 -->
                <div id="markdown-preview" style="display: none;">
                    <h6 style="margin-bottom: 12px; color: #374151;">预览:</h6>
                    <div id="preview-content" style="line-height: 1.6;"></div>
                </div>
            </div>
        </div>

        <!-- 操作按钮 -->
        <div class="action-buttons">
            <button type="submit" form="postForm" class="btn btn-primary">
                <i class="fas fa-save me-2"></i>保存文章
            </button>
            <button type="button" class="btn btn-secondary" onclick="history.back()">
                <i class="fas fa-times me-2"></i>取消
            </button>
        </div>
    </div>

    <!-- 右侧边栏 -->
    <div class="sidebar">
        <!-- 发布选项 -->
        <div class="content-card">
            <div class="content-card-header sidebar-header">发布选项</div>
            <div class="content-card-body">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="is_published" name="is_published"
                           form="postForm" {% if not post or post.is_published %}checked{% endif %}>
                    <label class="form-check-label" for="is_published">发布文章</label>
                </div>
                
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="is_featured" name="is_featured"
                           form="postForm" {% if post.is_featured %}checked{% endif %}>
                    <label class="form-check-label" for="is_featured">推荐文章</label>
                </div>
                
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="is_vip_only" name="is_vip_only"
                           form="postForm" {% if post.is_vip_only %}checked{% endif %}>
                    <label class="form-check-label" for="is_vip_only">
                        <i class="fas fa-crown text-warning me-1"></i>设为VIP文章
                    </label>
                    <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                        仅VIP用户可以阅读此文章
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 分类选择 -->
        <div class="content-card">
            <div class="content-card-header sidebar-header">文章分类</div>
            <div class="content-card-body">
                <select class="form-control" name="category" form="postForm">
                    <option value="">请选择分类</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}" 
                                {% if post.category_id == category.id %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <!-- 标签选择 -->
        <div class="content-card">
            <div class="content-card-header sidebar-header">文章标签</div>
            <div class="content-card-body">
                {% for tag in tags %}
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="tag_{{ tag.id }}" 
                               name="tags" value="{{ tag.id }}" form="postForm"
                               {% if post and tag in post.tags.all %}checked{% endif %}>
                        <label class="form-check-label" for="tag_{{ tag.id }}">
                            {{ tag.name }}
                        </label>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- CKEditor 5 CDN -->
<script src="https://cdn.ckeditor.com/ckeditor5/40.2.0/classic/ckeditor.js"></script>
<!-- Marked.js for Markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

<script>
let currentEditorMode = 'rich';
let ckEditorInstance = null;

// 初始化CKEditor
function initCKEditor() {
    if (ckEditorInstance) {
        return;
    }
    
    ClassicEditor
        .create(document.querySelector('#content'), {
            toolbar: {
                items: [
                    'heading', '|',
                    'bold', 'italic', 'underline', 'strikethrough', '|',
                    'link', 'bulletedList', 'numberedList', '|',
                    'outdent', 'indent', '|',
                    'imageUpload', 'blockQuote', 'insertTable', '|',
                    'undo', 'redo', '|',
                    'alignment', 'fontColor', 'fontBackgroundColor', '|',
                    'code', 'codeBlock', 'sourceEditing'
                ]
            },
            language: 'zh-cn',
            heading: {
                options: [
                    { model: 'paragraph', title: '段落', class: 'ck-heading_paragraph' },
                    { model: 'heading1', view: 'h1', title: '标题 1', class: 'ck-heading_heading1' },
                    { model: 'heading2', view: 'h2', title: '标题 2', class: 'ck-heading_heading2' },
                    { model: 'heading3', view: 'h3', title: '标题 3', class: 'ck-heading_heading3' }
                ]
            }
        })
        .then(editor => {
            ckEditorInstance = editor;
            // 设置编辑器高度
            const editable = editor.ui.getEditableElement();
            if (editable) {
                editable.style.minHeight = '400px';
            }
        })
        .catch(error => {
            console.error('CKEditor初始化失败:', error);
        });
}

// 销毁CKEditor
function destroyCKEditor() {
    if (ckEditorInstance) {
        ckEditorInstance.destroy()
            .then(() => {
                ckEditorInstance = null;
            })
            .catch(error => {
                console.error('销毁CKEditor失败:', error);
            });
    }
}

// 初始化Markdown编辑器
function initMarkdownEditor() {
    const textarea = document.getElementById('content');
    const previewDiv = document.getElementById('markdown-preview');
    
    previewDiv.style.display = 'block';
    textarea.style.fontFamily = '"Courier New", monospace';
    textarea.style.fontSize = '14px';
    
    // 监听输入变化
    textarea.addEventListener('input', updateMarkdownPreview);
    updateMarkdownPreview();
}

// 清理Markdown编辑器
function cleanupMarkdownEditor() {
    const previewDiv = document.getElementById('markdown-preview');
    const textarea = document.getElementById('content');
    
    previewDiv.style.display = 'none';
    textarea.style.fontFamily = '';
    textarea.style.fontSize = '';
}

// 更新Markdown预览
function updateMarkdownPreview() {
    const textarea = document.getElementById('content');
    const previewContent = document.getElementById('preview-content');
    
    if (textarea && previewContent) {
        const markdownText = textarea.value;
        const htmlContent = marked.parse(markdownText);
        previewContent.innerHTML = htmlContent;
    }
}

// 切换编辑器模式
function switchEditorMode(mode) {
    const richBtn = document.getElementById('rich-mode-btn');
    const markdownBtn = document.getElementById('markdown-mode-btn');
    
    if (mode === 'rich') {
        currentEditorMode = 'rich';
        richBtn.classList.add('active');
        markdownBtn.classList.remove('active');
        
        cleanupMarkdownEditor();
        setTimeout(() => {
            initCKEditor();
        }, 100);
    } else {
        currentEditorMode = 'markdown';
        markdownBtn.classList.add('active');
        richBtn.classList.remove('active');
        
        destroyCKEditor();
        setTimeout(() => {
            initMarkdownEditor();
        }, 100);
    }
}

// 表单提交验证
document.getElementById('postForm').addEventListener('submit', function(e) {
    const title = document.getElementById('title').value.trim();
    let content = '';
    
    if (currentEditorMode === 'rich' && ckEditorInstance) {
        content = ckEditorInstance.getData().trim();
        document.getElementById('content').value = ckEditorInstance.getData();
    } else {
        content = document.getElementById('content').value.trim();
    }
    
    if (!title || !content) {
        e.preventDefault();
        alert('标题和内容不能为空');
        return false;
    }
});

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    initCKEditor();
});
</script>
{% endblock %}