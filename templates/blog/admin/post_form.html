{% extends 'blog/admin/base.html' %}
{% load static %}

{% block page_title %}{{ title }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/admin-common.css' %}">
<link rel="stylesheet" href="{% static 'css/admin-post-form.css' %}">
<!-- Quill编辑器样式 -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
{% endblock %}

{% block page_actions %}
<div class="page-actions-admin">
    <a href="{% url 'blog:admin_posts' %}" class="btn-admin secondary">
        <i class="fas fa-arrow-left"></i>返回列表
    </a>
</div>
{% endblock %}

{% block admin_content %}
<div class="row">
    <!-- 主内容区域 -->
    <div class="col-xl-8 col-lg-7">
        {% if messages %}
            {% for message in messages %}
                <div class="alert-admin {{ message.tags }}" role="alert">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        {{ message }}
                    </div>
                    <button type="button" class="alert-admin-close" onclick="this.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            {% endfor %}
        {% endif %}

        <!-- 基本信息卡片 -->
        <div class="admin-card mb-4">
            <div class="admin-card-header">
                <i class="fas fa-info-circle"></i>文章基本信息
            </div>
            <div class="admin-card-body">
                <form method="post" enctype="multipart/form-data" id="postForm">
                    {% csrf_token %}
                    
                    <div class="form-group-admin">
                        <label for="title" class="form-label-admin">
                            <i class="fas fa-heading"></i>文章标题<span class="required">*</span>
                        </label>
                        <input type="text" class="form-input-admin" id="title" name="title" 
                               value="{% if post %}{{ post.title }}{% endif %}" required 
                               placeholder="请输入文章标题">
                    </div>
                    
                    <div class="form-group-admin">
                        <label for="summary" class="form-label-admin">
                            <i class="fas fa-align-left"></i>文章摘要
                        </label>
                        <textarea class="form-input-admin" id="summary" name="summary" rows="3" 
                                  placeholder="请输入文章摘要（可选）">{% if post %}{{ post.summary }}{% endif %}</textarea>
                        <div class="form-help-text">文章摘要将显示在文章列表中，有助于读者快速了解内容</div>
                    </div>
                    
                    <div class="form-group-admin">
                        <label for="cover_image" class="form-label-admin">
                            <i class="fas fa-image"></i>封面图片
                        </label>
                        <input type="file" class="form-input-admin" id="cover_image" name="cover_image" accept="image/*">
                        {% if post.cover_image %}
                            <div class="mt-3">
                                <img src="{{ post.cover_image }}" alt="当前封面" 
                                     style="max-width: 200px; height: auto; border-radius: var(--radius-md); border: 1px solid var(--gray-200);">
                                <div class="form-help-text">当前封面图片</div>
                            </div>
                        {% endif %}
                        <div class="form-help-text">推荐尺寸：1200x630像素，支持JPG、PNG格式</div>
                    </div>
                </form>
            </div>
        </div>

        <!-- 内容编辑器卡片 -->
        <div class="admin-card mb-4">
            <div class="admin-card-header">
                <div class="d-flex justify-content-between align-items-center w-100">
                    <span><i class="fas fa-edit"></i>文章内容<span class="required">*</span></span>
                    <div class="d-flex gap-sm">
                        <button type="button" class="btn-admin primary small" id="rich-mode-btn" onclick="switchEditorMode('rich')">
                            <i class="fas fa-font"></i>富文本
                        </button>
                        <button type="button" class="btn-admin outline small" id="markdown-mode-btn" onclick="switchEditorMode('markdown')">
                            <i class="fab fa-markdown"></i>Markdown
                        </button>
                    </div>
                </div>
            </div>
            <div class="admin-card-body">
                <!-- Quill富文本编辑器 -->
                <div id="editor-container">
                    <div id="quill-editor" style="display: block;"></div>
                    <textarea id="content" name="content" form="postForm" style="display: none;" required>{% if post %}{{ post.content|safe }}{% endif %}</textarea>
                </div>
                
                <!-- Markdown编辑器 -->
                <div id="markdown-container" style="display: none;">
                    <textarea class="form-control" id="markdown-input" rows="20" 
                              placeholder="开始编写你的Markdown内容...">{% if post %}{{ post.content|safe }}{% endif %}</textarea>
                    
                    <!-- Markdown 预览区域 -->
                    <div id="markdown-preview">
                        <h6><i class="fas fa-eye me-1"></i>预览:</h6>
                        <div id="preview-content"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 操作按钮 -->
        <div class="d-flex gap-md mb-4">
            <button type="submit" form="postForm" class="btn-admin primary large">
                <i class="fas fa-save"></i>保存文章
            </button>
            <button type="button" class="btn-admin secondary large" onclick="history.back()">
                <i class="fas fa-times"></i>取消
            </button>
        </div>
    </div>

    <!-- 右侧边栏 -->
    <div class="col-xl-4 col-lg-5">
        <!-- 发布选项 -->
        <div class="admin-card mb-4">
            <div class="admin-card-header success">
                <i class="fas fa-rocket"></i>发布选项
            </div>
            <div class="admin-card-body">
                <div class="form-check-admin">
                    <input class="form-check-input-admin" type="checkbox" id="is_published" name="is_published"
                           form="postForm" {% if not post or post.is_published %}checked{% endif %}>
                    <label class="form-check-label-admin" for="is_published">
                        <i class="fas fa-globe"></i>发布文章
                    </label>
                </div>
                
                <div class="form-check-admin">
                    <input class="form-check-input-admin" type="checkbox" id="is_featured" name="is_featured"
                           form="postForm" {% if post.is_featured %}checked{% endif %}>
                    <label class="form-check-label-admin" for="is_featured">
                        <i class="fas fa-star"></i>推荐文章
                    </label>
                </div>
                
                <div class="form-check-admin">
                    <input class="form-check-input-admin" type="checkbox" id="is_vip_only" name="is_vip_only"
                           form="postForm" {% if post.is_vip_only %}checked{% endif %}>
                    <label class="form-check-label-admin" for="is_vip_only">
                        <i class="fas fa-crown"></i>设为VIP文章
                    </label>
                </div>
                <div class="form-help-text">仅VIP用户可以阅读此文章</div>
            </div>
        </div>
        
        <!-- 分类选择 -->
        <div class="admin-card mb-4">
            <div class="admin-card-header">
                <i class="fas fa-folder"></i>文章分类
            </div>
            <div class="admin-card-body">
                <div class="form-group-admin">
                    <select class="form-input-admin form-select-admin" name="category" form="postForm">
                        <option value="">请选择分类</option>
                        {% for category in categories %}
                            <option value="{{ category.id }}" 
                                    {% if post.category_id == category.id %}selected{% endif %}>
                                {{ category.name }}
                            </option>
                        {% endfor %}
                    </select>
                    <div class="form-help-text">选择适合的分类有助于读者找到相关内容</div>
                </div>
            </div>
        </div>
        
        <!-- 标签选择 -->
        <div class="admin-card mb-4">
            <div class="admin-card-header">
                <i class="fas fa-tags"></i>文章标签
            </div>
            <div class="admin-card-body">
                {% for tag in tags %}
                    <div class="form-check-admin">
                        <input class="form-check-input-admin" type="checkbox" id="tag_{{ tag.id }}" 
                               name="tags" value="{{ tag.id }}" form="postForm"
                               {% if post and tag in post.tags.all %}checked{% endif %}>
                        <label class="form-check-label-admin" for="tag_{{ tag.id }}">
                            <i class="fas fa-tag"></i>{{ tag.name }}
                        </label>
                    </div>
                {% endfor %}
                {% if not tags %}
                    <div class="text-center" style="color: var(--gray-500); padding: 2rem;">
                        <i class="fas fa-tags" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>暂无可用标签</p>
                        <a href="{% url 'blog:admin_tags' %}" class="btn-admin outline small">
                            <i class="fas fa-plus"></i>新增标签
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Quill编辑器 -->
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<!-- Marked.js for Markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

<script>
let currentEditorMode = 'rich';
let quillEditor = null;
let isQuillInitialized = false;

// 初始化Quill编辑器
function initQuillEditor() {
    if (isQuillInitialized) {
        return;
    }
    
    quillEditor = new Quill('#quill-editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'font': [] }],
                [{ 'align': [] }],
                ['blockquote', 'code-block'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'indent': '-1'}, { 'indent': '+1' }],
                ['link', 'image'],
                ['clean']
            ]
        },
        placeholder: '开始编写你的文章内容...'
    });
    
    // 设置初始内容
    const contentField = document.getElementById('content');
    const initialContent = contentField ? contentField.value : '';
    console.log('Content字段存在:', !!contentField);
    console.log('初始内容:', initialContent);
    console.log('内容长度:', initialContent.length);
    
    if (initialContent && initialContent.trim() !== '' && initialContent.trim() !== '<p><br></p>') {
        // 清理空的HTML标签，设置实际内容
        const cleanContent = initialContent.replace(/^<p><br><\/p>$/g, '').trim();
        if (cleanContent !== '') {
            quillEditor.root.innerHTML = initialContent;
            console.log('已设置初始内容到Quill编辑器');
            contentField.value = initialContent;
        } else {
            console.log('内容为空的HTML标签，忽略');
        }
    } else {
        console.log('没有初始内容或内容为空');
    }
    
    // 监听内容变化
    quillEditor.on('text-change', function() {
        document.getElementById('content').value = quillEditor.root.innerHTML;
    });
    
    isQuillInitialized = true;
    console.log('Quill编辑器初始化完成');
}

// 初始化Markdown编辑器
function initMarkdownEditor() {
    const markdownInput = document.getElementById('markdown-input');
    const previewContent = document.getElementById('preview-content');
    
    // 设置初始内容
    const contentField = document.getElementById('content');
    const currentContent = contentField ? contentField.value : '';
    console.log('Markdown编辑器初始化');
    console.log('Markdown初始内容:', currentContent);
    console.log('Markdown内容长度:', currentContent.length);
    
    if (currentContent && currentContent.trim() !== '') {
        markdownInput.value = currentContent;
        console.log('已设置初始内容到Markdown编辑器');
    } else {
        console.log('Markdown编辑器没有初始内容');
    }
    
    // 监听输入变化
    markdownInput.addEventListener('input', function() {
        updateMarkdownPreview();
        document.getElementById('content').value = markdownInput.value;
    });
    
    // 初始预览
    updateMarkdownPreview();
    console.log('Markdown编辑器初始化完成');
}

// 更新Markdown预览
function updateMarkdownPreview() {
    const markdownInput = document.getElementById('markdown-input');
    const previewContent = document.getElementById('preview-content');
    
    if (markdownInput && previewContent) {
        const markdownText = markdownInput.value;
        const htmlContent = marked.parse(markdownText);
        previewContent.innerHTML = htmlContent;
    }
}

// 切换编辑器模式
function switchEditorMode(mode) {
    const richBtn = document.getElementById('rich-mode-btn');
    const markdownBtn = document.getElementById('markdown-mode-btn');
    const editorContainer = document.getElementById('editor-container');
    const markdownContainer = document.getElementById('markdown-container');
    
    // 保存当前内容
    let currentContent = '';
    const contentField = document.getElementById('content');
    
    if (currentEditorMode === 'rich' && quillEditor) {
        currentContent = quillEditor.root.innerHTML;
        contentField.value = currentContent;
    } else if (currentEditorMode === 'markdown') {
        const markdownInput = document.getElementById('markdown-input');
        currentContent = markdownInput ? markdownInput.value : '';
        contentField.value = currentContent;
    }
    
    console.log('切换编辑器模式，当前内容:', currentContent);
    
    if (mode === 'rich') {
        currentEditorMode = 'rich';
        richBtn.classList.remove('outline');
        richBtn.classList.add('primary');
        markdownBtn.classList.remove('primary');
        markdownBtn.classList.add('outline');
        
        editorContainer.style.display = 'block';
        markdownContainer.style.display = 'none';
        
        // 初始化Quill编辑器
        setTimeout(() => {
            initQuillEditor();
            if (currentContent && quillEditor) {
                quillEditor.root.innerHTML = currentContent;
                document.getElementById('content').value = currentContent;
            }
        }, 100);
        
    } else {
        currentEditorMode = 'markdown';
        markdownBtn.classList.remove('outline');
        markdownBtn.classList.add('primary');
        richBtn.classList.remove('primary');
        richBtn.classList.add('outline');
        
        editorContainer.style.display = 'none';
        markdownContainer.style.display = 'block';
        
        // 初始化Markdown编辑器
        setTimeout(() => {
            const markdownInput = document.getElementById('markdown-input');
            if (currentContent) {
                markdownInput.value = currentContent;
                document.getElementById('content').value = currentContent;
            }
            initMarkdownEditor();
        }, 100);
    }
}

// 表单提交验证
document.getElementById('postForm').addEventListener('submit', function(e) {
    const title = document.getElementById('title').value.trim();
    let content = '';
    
    if (currentEditorMode === 'rich' && quillEditor) {
        content = quillEditor.root.innerHTML.trim();
        document.getElementById('content').value = content;
    } else if (currentEditorMode === 'markdown') {
        content = document.getElementById('markdown-input').value.trim();
        document.getElementById('content').value = content;
    }
    
    // 检查内容是否为空（排除只有HTML标签的情况）
    const textContent = content.replace(/<[^>]*>/g, '').trim();
    
    if (!title || !textContent) {
        e.preventDefault();
        alert('标题和内容不能为空');
        return false;
    }
});

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    console.log('页面加载完成，初始化编辑器');
    
    // 等待一小段时间确保DOM完全渲染
    setTimeout(() => {
        const contentField = document.getElementById('content');
        console.log('Content字段值:', contentField ? contentField.value : '字段不存在');
        initQuillEditor();
    }, 100);
});
</script>
{% endblock %}