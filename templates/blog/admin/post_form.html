{% extends 'blog/admin/base.html' %}
{% load static %}

{% block page_title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin-post-form.css' %}">
<!-- Quill编辑器样式 -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
{% endblock %}

{% block page_actions %}
<a href="{% url 'blog:admin_posts' %}" class="btn btn-secondary">
    <i class="fas fa-arrow-left me-2"></i>返回列表
</a>
{% endblock %}

{% block admin_content %}
<div class="article-edit-container">
    <!-- 主内容区域 -->
    <div class="main-content">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert" style="margin-bottom: 20px;">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        <!-- 基本信息卡片 -->
        <div class="content-card">
            <div class="content-card-header info-header">
                <i class="fas fa-info-circle me-2"></i>文章基本信息
            </div>
            <div class="content-card-body">
                <form method="post" enctype="multipart/form-data" id="postForm">
                    {% csrf_token %}
                    
                    <div class="form-section">
                        <label for="title" class="form-label">
                            <i class="fas fa-heading me-1"></i>文章标题 *
                        </label>
                        <input type="text" class="form-control" id="title" name="title" 
                               value="{% if post %}{{ post.title }}{% endif %}" required 
                               placeholder="请输入文章标题">
                    </div>
                    
                    <div class="form-section">
                        <label for="summary" class="form-label">
                            <i class="fas fa-align-left me-1"></i>文章摘要
                        </label>
                        <textarea class="form-control" id="summary" name="summary" rows="3" 
                                  placeholder="请输入文章摘要（可选）">{% if post %}{{ post.summary }}{% endif %}</textarea>
                    </div>
                    
                    <div class="form-section">
                        <label for="cover_image" class="form-label">
                            <i class="fas fa-image me-1"></i>封面图片
                        </label>
                        <input type="file" class="form-control" id="cover_image" name="cover_image" accept="image/*">
                        {% if post.cover_image %}
                            <div style="margin-top: 12px;">
                                <img src="{{ post.cover_image }}" alt="当前封面" style="max-width: 200px; height: auto; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">当前封面图片</p>
                            </div>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>

        <!-- 内容编辑器卡片 -->
        <div class="content-card">
            <div class="content-card-header editor-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span><i class="fas fa-edit me-2"></i>文章内容 *</span>
                    <div class="editor-toggle">
                        <button type="button" class="btn active" id="rich-mode-btn" onclick="switchEditorMode('rich')">
                            <i class="fas fa-font me-1"></i>富文本编辑
                        </button>
                        <button type="button" class="btn" id="markdown-mode-btn" onclick="switchEditorMode('markdown')">
                            <i class="fab fa-markdown me-1"></i>Markdown
                        </button>
                    </div>
                </div>
            </div>
            <div class="content-card-body">
                <!-- Quill富文本编辑器 -->
                <div id="editor-container">
                    <div id="quill-editor" style="display: block;"></div>
                    <textarea id="content" name="content" form="postForm" style="display: none;" required>{% if post %}{{ post.content }}{% endif %}</textarea>
                </div>
                
                <!-- Markdown编辑器 -->
                <div id="markdown-container" style="display: none;">
                    <textarea class="form-control" id="markdown-input" rows="20" 
                              placeholder="开始编写你的Markdown内容...">{% if post %}{{ post.content }}{% endif %}</textarea>
                    
                    <!-- Markdown 预览区域 -->
                    <div id="markdown-preview">
                        <h6><i class="fas fa-eye me-1"></i>预览:</h6>
                        <div id="preview-content"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 操作按钮 -->
        <div class="action-buttons">
            <button type="submit" form="postForm" class="btn btn-primary">
                <i class="fas fa-save me-2"></i>保存文章
            </button>
            <button type="button" class="btn btn-secondary" onclick="history.back()">
                <i class="fas fa-times me-2"></i>取消
            </button>
        </div>
    </div>

    <!-- 右侧边栏 -->
    <div class="sidebar">
        <!-- 发布选项 -->
        <div class="content-card">
            <div class="content-card-header sidebar-header">
                <i class="fas fa-rocket me-2"></i>发布选项
            </div>
            <div class="content-card-body">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="is_published" name="is_published"
                           form="postForm" {% if not post or post.is_published %}checked{% endif %}>
                    <label class="form-check-label" for="is_published">
                        <i class="fas fa-globe me-1 text-success"></i>发布文章
                    </label>
                </div>
                
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="is_featured" name="is_featured"
                           form="postForm" {% if post.is_featured %}checked{% endif %}>
                    <label class="form-check-label" for="is_featured">
                        <i class="fas fa-star me-1 text-warning"></i>推荐文章
                    </label>
                </div>
                
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="is_vip_only" name="is_vip_only"
                           form="postForm" {% if post.is_vip_only %}checked{% endif %}>
                    <label class="form-check-label" for="is_vip_only">
                        <i class="fas fa-crown me-1 text-warning"></i>设为VIP文章
                    </label>
                    <div style="font-size: 12px; color: #6b7280; margin-top: 4px; margin-left: 20px;">
                        仅VIP用户可以阅读此文章
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 分类选择 -->
        <div class="content-card">
            <div class="content-card-header sidebar-header">
                <i class="fas fa-folder me-2"></i>文章分类
            </div>
            <div class="content-card-body">
                <select class="form-control" name="category" form="postForm">
                    <option value="">请选择分类</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}" 
                                {% if post.category_id == category.id %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <!-- 标签选择 -->
        <div class="content-card">
            <div class="content-card-header sidebar-header">
                <i class="fas fa-tags me-2"></i>文章标签
            </div>
            <div class="content-card-body">
                {% for tag in tags %}
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="tag_{{ tag.id }}" 
                               name="tags" value="{{ tag.id }}" form="postForm"
                               {% if post and tag in post.tags.all %}checked{% endif %}>
                        <label class="form-check-label" for="tag_{{ tag.id }}">
                            <i class="fas fa-tag me-1"></i>{{ tag.name }}
                        </label>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Quill编辑器 -->
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<!-- Marked.js for Markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

<script>
let currentEditorMode = 'rich';
let quillEditor = null;
let isQuillInitialized = false;

// 初始化Quill编辑器
function initQuillEditor() {
    if (isQuillInitialized) {
        return;
    }
    
    quillEditor = new Quill('#quill-editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'font': [] }],
                [{ 'align': [] }],
                ['blockquote', 'code-block'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'indent': '-1'}, { 'indent': '+1' }],
                ['link', 'image'],
                ['clean']
            ]
        },
        placeholder: '开始编写你的文章内容...'
    });
    
    // 设置初始内容
    const initialContent = document.getElementById('content').value;
    if (initialContent) {
        quillEditor.root.innerHTML = initialContent;
    }
    
    // 监听内容变化
    quillEditor.on('text-change', function() {
        document.getElementById('content').value = quillEditor.root.innerHTML;
    });
    
    isQuillInitialized = true;
    console.log('Quill编辑器初始化完成');
}

// 初始化Markdown编辑器
function initMarkdownEditor() {
    const markdownInput = document.getElementById('markdown-input');
    const previewContent = document.getElementById('preview-content');
    
    // 设置初始内容
    const currentContent = document.getElementById('content').value;
    if (currentContent) {
        markdownInput.value = currentContent;
    }
    
    // 监听输入变化
    markdownInput.addEventListener('input', function() {
        updateMarkdownPreview();
        document.getElementById('content').value = markdownInput.value;
    });
    
    // 初始预览
    updateMarkdownPreview();
    console.log('Markdown编辑器初始化完成');
}

// 更新Markdown预览
function updateMarkdownPreview() {
    const markdownInput = document.getElementById('markdown-input');
    const previewContent = document.getElementById('preview-content');
    
    if (markdownInput && previewContent) {
        const markdownText = markdownInput.value;
        const htmlContent = marked.parse(markdownText);
        previewContent.innerHTML = htmlContent;
    }
}

// 切换编辑器模式
function switchEditorMode(mode) {
    const richBtn = document.getElementById('rich-mode-btn');
    const markdownBtn = document.getElementById('markdown-mode-btn');
    const editorContainer = document.getElementById('editor-container');
    const markdownContainer = document.getElementById('markdown-container');
    
    // 保存当前内容
    let currentContent = '';
    if (currentEditorMode === 'rich' && quillEditor) {
        currentContent = quillEditor.root.innerHTML;
    } else if (currentEditorMode === 'markdown') {
        currentContent = document.getElementById('markdown-input').value;
    }
    
    if (mode === 'rich') {
        currentEditorMode = 'rich';
        richBtn.classList.add('active');
        markdownBtn.classList.remove('active');
        
        editorContainer.style.display = 'block';
        markdownContainer.style.display = 'none';
        
        // 初始化Quill编辑器
        setTimeout(() => {
            initQuillEditor();
            if (currentContent && quillEditor) {
                quillEditor.root.innerHTML = currentContent;
                document.getElementById('content').value = currentContent;
            }
        }, 100);
        
    } else {
        currentEditorMode = 'markdown';
        markdownBtn.classList.add('active');
        richBtn.classList.remove('active');
        
        editorContainer.style.display = 'none';
        markdownContainer.style.display = 'block';
        
        // 初始化Markdown编辑器
        setTimeout(() => {
            const markdownInput = document.getElementById('markdown-input');
            if (currentContent) {
                markdownInput.value = currentContent;
                document.getElementById('content').value = currentContent;
            }
            initMarkdownEditor();
        }, 100);
    }
}

// 表单提交验证
document.getElementById('postForm').addEventListener('submit', function(e) {
    const title = document.getElementById('title').value.trim();
    let content = '';
    
    if (currentEditorMode === 'rich' && quillEditor) {
        content = quillEditor.root.innerHTML.trim();
        document.getElementById('content').value = content;
    } else if (currentEditorMode === 'markdown') {
        content = document.getElementById('markdown-input').value.trim();
        document.getElementById('content').value = content;
    }
    
    // 检查内容是否为空（排除只有HTML标签的情况）
    const textContent = content.replace(/<[^>]*>/g, '').trim();
    
    if (!title || !textContent) {
        e.preventDefault();
        alert('标题和内容不能为空');
        return false;
    }
});

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    console.log('页面加载完成，初始化编辑器');
    initQuillEditor();
});
</script>
{% endblock %}